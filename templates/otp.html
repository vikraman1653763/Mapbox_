<!-- otp.html -->
{% extends 'lbody.html' %}
  
    {% block login %}
    <body>
      <script src="{{ url_for('static', filename='js/otp.js') }}"></script>
      <link rel="stylesheet" href="{{ url_for('static', filename='styles/Otp.css') }}"> 
      <p>Check your email for the OTP</p>
      <p>If you don't see the email in your inbox, please make sure to check your spam or junk folder.</p>
              <div class="otpverify">
  
              <div class="wave-group">
                <input required="" type="text" class="input" id="otp_inp">
                <span class="bar"></span>
                <label class="label">
                  <span class="label-char" style="--index: 0">E</span>
                  <span class="label-char" style="--index: 1">n</span>
                  <span class="label-char" style="--index: 2">t</span>
                  <span class="label-char" style="--index: 3">e</span>
                  <span class="label-char" style="--index: 4">r</span>
                  <span class="label-char" style="--index: 5">&nbsp;</span>
                  <span class="label-char" style="--index: 6">y</span>
                  <span class="label-char" style="--index: 7">o</span>
                  <span class="label-char" style="--index: 8">u</span>
                  <span class="label-char" style="--index: 9">r</span>
                  <span class="label-char" style="--index: 10">&nbsp;</span>
                  <span class="label-char" style="--index: 11">O</span>
                  <span class="label-char" style="--index: 12">T</span>
                  <span class="label-char" style="--index: 13">P</span>
                  
                </label>
              </div>
            <button class="btn button " id="otp-btn" onclick="verifyOTP()">Verify<svg fill="currentColor" viewBox="0 0 924 24" class="icon"></svg></button>
        </div>
<script type="text/javascript">

  function verifyOTP() {
    const otpInput = document.getElementById('otp_inp');
    
    if (otpInput) {
        // Now check whether the entered OTP is valid
        if (otpInput.value == localStorage.getItem('otpValue')) {
            // Optional alert or other actions
            localStorage.removeItem('otpValue');
            const emailValue = localStorage.getItem('email');
            const usernameValue = localStorage.getItem('username');
            const lastnameValue = localStorage.getItem('lastname');
            const passwordValue = localStorage.getItem('password');
            console.log( emailValue, usernameValue, lastnameValue, passwordValue);
           
            // Call sendUserData with user details
            sendUserData(emailValue, usernameValue, lastnameValue, passwordValue);
            window.location.href = 'otp';

        } else {
            alert("Invalid OTP");
        }
    } else {
        console.error("Error: Could not find element with id 'otp_input'");
    }
}


function sendUserData(emailValue) {
    // Send user data to Flask for saving
    fetch('/verify_otp', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            username: localStorage.getItem('username'),
            lastname: localStorage.getItem('lastname'),
            email: emailValue,
            password: localStorage.getItem('password'),
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
          
            window.location.href = 'login';
        } else {
          window.location.href = 'register';
        }
    })
    .catch(error => {
        console.error('Error sending user data:', error);
    });
}


</script>

        {% endblock %}